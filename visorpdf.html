<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Presentaci√≥n PDF (Optimizada con QA)</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

  <script defer src="./pdf.min.js"></script>
  <script defer src="./pdf.worker.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; background: #f0f4f8; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
    canvas { box-shadow: 0 8px 25px rgba(0,0,0,.1); border-radius: 8px; visibility: hidden; will-change: transform; }
    #glass-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.25); backdrop-filter: blur(8px) saturate(150%); -webkit-backdrop-filter: blur(8px) saturate(150%); opacity: 0; pointer-events: none; transition: opacity .24s ease-in-out; z-index: 15; }
    #glass-overlay.active { opacity: 1; }
    .nav-button { position: absolute; top: 50%; transform: translateY(-50%); background:#6C7A89; border:none; padding:15px; font-size:24px; color:#fff; cursor:pointer; z-index:20; border-radius:10px; width:50px; height:50px; display:flex; justify-content:center; align-items:center; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:background-color .2s, box-shadow .2s; }
    .nav-button:hover { background:#5A6673; box-shadow:0 6px 12px rgba(0,0,0,.3);} .nav-button:disabled{opacity:.4;cursor:not-allowed;} #prev-button{left:10px;}#next-button{right:10px;}
    #main-controls-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:50%;max-width:500px;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 12px;background:rgba(255,255,255,.8);border-radius:25px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:20;}
    #left-controls,#center-controls,#right-controls{display:flex;align-items:center;gap:8px;}#center-controls{flex-grow:1;}
    #progress-container{flex-grow:1;height:12px;background:#e9ecef;border-radius:6px;overflow:hidden;}#progress-bar{height:100%;width:0%;background:#28a745;transition:width .2s ease-in-out;}
    #timer{display:flex;align-items:center;padding:8px 15px;background:#fff;border-radius:20px;border:1px solid #28a745;box-shadow:0 2px 5px rgba(0,0,0,.05);font-family:sans-serif;font-size:16px;color:#343a40;}#timer .icon{margin-right:8px;}
    .control-button{background:#6C7A89;border:none;border-radius:50%;width:36px;height:36px;font-size:18px;cursor:pointer;transition:background-color .15s;box-shadow:0 2px 4px rgba(0,0,0,.1);color:#fff;display:flex;justify-content:center;align-items:center;}
    .control-button:hover{background:#5A6673;} .control-button.active{background:#28a745;}
    #trophy-icon{width:45px;height:45px;display:none;animation:medal-bounce .8s infinite alternate;font-size:32px;display:flex;justify-content:center;align-items:center;}
    @keyframes medal-bounce{from{transform:translateY(0);}to{transform:translateY(-8px);}}
    #trophy-explosion-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:1px;height:1px;overflow:visible;pointer-events:none;z-index:25;}
    .explosion-trophy{position:absolute;font-size:40px;opacity:0;white-space:nowrap;filter:drop-shadow(0 0 5px rgba(255,215,0,.7));animation:trophyExplode 3s ease-out forwards;}
    @keyframes trophyExplode{0%{opacity:0;transform:translate(0,0) scale(.5);}12%{opacity:1;transform:translate(var(--dx),var(--dy)) scale(1);}55%{opacity:1;transform:translate(calc(var(--dx)*1.4),calc(var(--dy)*1.4)) scale(1.08);}100%{opacity:0;transform:translate(calc(var(--dx)*2),calc(var(--dy)*2)) scale(.85);}}
    #error-message{color:red;font-family:sans-serif;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
  </style>
</head>
<body>
  <button id="prev-button" class="nav-button">&lt;</button>
  <button id="next-button" class="nav-button">&gt;</button>
  <canvas id="pdf-canvas"></canvas>
  <div id="glass-overlay"></div>
  <div id="trophy-explosion-container"></div>
  <div id="main-controls-container">
    <div id="left-controls"><button class="control-button" id="reset-zoom-btn">‚ü≥</button><button class="control-button" id="zoom-in-btn">+</button><button class="control-button" id="zoom-out-btn">-</button><button class="control-button" id="hand-btn">‚úã</button></div>
    <div id="center-controls"><div id="progress-container"><div id="progress-bar"></div></div></div>
    <div id="right-controls"><div id="trophy-icon">üèÜ</div><div id="timer"><span class="icon">‚è∞</span><span id="timer-text">00:00</span></div></div>
  </div>
  <div id="error-message"></div>
  <audio id="victory-sound" src="./audio_c8f5ec4c7e.mp3" preload="auto"></audio>
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const params=new URLSearchParams(window.location.search);
    const pdfUrl=params.get('pdf');
    if(!pdfUrl){document.getElementById("error-message").textContent="Error: no se encontr√≥ el PDF (?pdf=URL)";return;}

    let pdfDoc=null,pageNum=1,scale=0.95,isHand=false,isDragging=false,lastX=0,lastY=0,tx=0,ty=0,isRendering=false,cache=new Map();
    const canvas=document.getElementById("pdf-canvas"),ctx=canvas.getContext("2d");
    const prevBtn=document.getElementById("prev-button"),nextBtn=document.getElementById("next-button"),progress=document.getElementById("progress-bar"),timerTxt=document.getElementById("timer-text"),handBtn=document.getElementById("hand-btn"),glass=document.getElementById("glass-overlay"),trophy=document.getElementById("trophy-icon"),trophyBox=document.getElementById("trophy-explosion-container"),sound=document.getElementById("victory-sound");

    pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    // Detectar soporte de Range Requests
    let supportsRange=false;
    try{supportsRange=await fetch(pdfUrl,{method:'HEAD'}).then(r=>r.headers.get('accept-ranges')==='bytes');}catch(e){}

    const options=supportsRange?{url:pdfUrl,rangeChunkSize:1<<16,disableStream:false,disableAutoFetch:false}:{url:pdfUrl,disableStream:true,disableAutoFetch:true};

    pdfjsLib.getDocument(options).promise.then(pdf=>{pdfDoc=pdf;renderPage(pageNum);setInterval(updateTimer,1000);}).catch(err=>{document.getElementById("error-message").textContent="Error al cargar PDF: "+err.message;});

    async function renderPage(num){isRendering=true;glass.classList.add("active");
      try{
        const page=await pdfDoc.getPage(num);
        const viewport=page.getViewport({scale:scale});
        canvas.width=viewport.width;canvas.height=viewport.height;
        await page.render({canvasContext:ctx,viewport}).promise;
        if(canvas.style.visibility!=='visible')canvas.style.visibility='visible';
        canvas.style.transform=`translate(${tx}px,${ty}px)`;
        cache.set(num,{canvas:canvas.toDataURL()});
      }catch(e){
        if(e.name==='RenderingCancelledException'){let c=cache.get(num);if(c){let img=new Image();img.src=c.canvas;img.onload=()=>ctx.drawImage(img,0,0);}}
      }finally{isRendering=false;glass.classList.remove("active");pageNum=num;updateUI();}
    }

    function updateUI(){prevBtn.disabled=(pageNum<=1);nextBtn.disabled=(pageNum>=pdfDoc.numPages);progress.style.width=(pageNum/pdfDoc.numPages*100)+"%";if(pageNum===pdfDoc.numPages){trophy.style.display='flex';if(!trophyBox.children.length)triggerTrophy();}else{trophy.style.display='none';}}

    function prevPage(){if(pageNum<=1||isRendering)return;renderPage(pageNum-1);} function nextPage(){if(pageNum>=pdfDoc.numPages||isRendering)return;renderPage(pageNum+1);} function zoomIn(){scale=Math.min(scale+.2,3);renderPage(pageNum);} function zoomOut(){scale=Math.max(scale-.2,.4);renderPage(pageNum);} function resetZoom(){scale=0.95;tx=0;ty=0;renderPage(pageNum);} function toggleHand(){isHand=!isHand;canvas.style.cursor=isHand?'grab':'default';handBtn.classList.toggle('active',isHand);}
    canvas.addEventListener('mousedown',e=>{if(!isHand)return;isDragging=true;lastX=e.clientX;lastY=e.clientY;canvas.style.cursor='grabbing';});
    canvas.addEventListener('mousemove',e=>{if(!isDragging)return;tx+=e.clientX-lastX;ty+=e.clientY-lastY;canvas.style.transform=`translate(${tx}px,${ty}px)`;lastX=e.clientX;lastY=e.clientY;},{passive:true});
    ['mouseup','mouseleave'].forEach(ev=>canvas.addEventListener(ev,()=>{isDragging=false;if(isHand)canvas.style.cursor='grab';}));

    function updateTimer(){let t=Math.floor((Date.now()-start)/1000),m=String(Math.floor(t/60)).padStart(2,'0'),s=String(t%60).padStart(2,'0');timerTxt.textContent=`${m}:${s}`;}
    let start=Date.now();

    function triggerTrophy(){sound.play().catch(()=>{});trophyBox.innerHTML='';for(let i=0;i<3;i++){setTimeout(()=>createBurst(8,160),i*220);}setTimeout(()=>trophyBox.innerHTML='',3000);}
    function createBurst(n,r){for(let i=0;i<n;i++){let d=document.createElement('div');d.textContent='üèÜ';d.classList.add('explosion-trophy');let a=Math.random()*2*Math.PI,dx=Math.cos(a)*(Math.random()*r+50),dy=Math.sin(a)*(Math.random()*r+50);d.style.setProperty('--dx',dx+'px');d.style.setProperty('--dy',dy+'px');trophyBox.appendChild(d);}}

    prevBtn.onclick=prevPage;nextBtn.onclick=nextPage;document.getElementById("zoom-in-btn").onclick=zoomIn;document.getElementById("zoom-out-btn").onclick=zoomOut;document.getElementById("reset-zoom-btn").onclick=resetZoom;handBtn.onclick=toggleHand;
  });
  </script>
</body>
</html>
