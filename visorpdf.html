<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Presentaci√≥n PDF con Transici√≥n de Cristal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%; background: #f0f4f8; display: flex;
      justify-content: center; align-items: center; overflow: hidden; position: relative;
    }
    canvas {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border-radius: 8px;
      visibility: hidden; /* Oculta el canvas hasta que est√© listo */
    }
    #glass-overlay {
      position: absolute; inset: 0; background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(8px) saturate(150%); -webkit-backdrop-filter: blur(8px) saturate(150%);
      opacity: 0; pointer-events: none;
      transition: opacity 1s ease-in-out;
      z-index: 15;
    }
    #glass-overlay.active {
      opacity: 1;
    }
    .nav-button {
      position: absolute; top: 50%; transform: translateY(-50%); background-color: #6C7A89;
      border: none; padding: 15px; font-size: 24px; color: #ffffff; cursor: pointer;
      z-index: 20; border-radius: 10px; width: 50px; height: 50px; display: flex;
      justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    .nav-button:hover { background-color: #5A6673; box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
    .nav-button:disabled { opacity: 0.4; cursor: not-allowed; }
    #prev-button { left: 10px; }
    #next-button { right: 10px; }
    #main-controls-container {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 50%; max-width: 500px; display: flex; align-items: center; justify-content: space-between;
      gap: 8px; padding: 8px 12px; background-color: rgba(255, 255, 255, 0.8);
      border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 20;
    }
    #left-controls, #center-controls, #right-controls { display: flex; align-items: center; gap: 8px; }
    #center-controls { flex-grow: 1; }
    #progress-container { flex-grow: 1; height: 12px; background-color: #e9ecef; border-radius: 6px; overflow: hidden; }
    #progress-bar { height: 100%; width: 0%; background-color: #28a745; transition: width 0.3s ease-in-out; }
    #timer { display: flex; align-items: center; padding: 8px 15px; background-color: #fff; border-radius: 20px; border: 1px solid #28a745; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-family: sans-serif; font-size: 16px; color: #343a40; }
    #timer .icon { margin-right: 8px; }
    .control-button { background-color: #6C7A89; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer; transition: background-color 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: #fff; display: flex; justify-content: center; align-items: center; }
    .control-button:hover { background-color: #5A6673; }
    .control-button.active { background-color: #28a745; color: #fff; }
    #trophy-icon {
      width: 45px;
      height: 45px;
      display: none;
      animation: medal-bounce 0.8s infinite alternate;
      font-size: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    @keyframes medal-bounce { from { transform: translateY(0); } to { transform: translateY(-8px); } }
    #error-message { color: red; font-family: sans-serif; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
  </style>
</head>
<body>
  <button id="prev-button" class="nav-button">&lt;</button>
  <button id="next-button" class="nav-button">&gt;</button>
  <canvas id="pdf-canvas"></canvas>
  <div id="glass-overlay"></div>
  <div id="main-controls-container">
    <div id="left-controls"><button class="control-button" id="reset-zoom-btn" title="Restablecer Zoom"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button><button class="control-button" id="zoom-in-btn" title="Acercar">+</button><button class="control-button" id="zoom-out-btn" title="Alejar">-</button><button class="control-button" id="hand-btn" title="Mover">‚úã</button></div>
    <div id="center-controls"><div id="progress-container"><div id="progress-bar"></div></div></div>
    <div id="right-controls">
      <div id="trophy-icon">üèÜ</div>
      <div id="timer"><span class="icon">‚è∞</span><span id="timer-text">00:00</span></div>
    </div>
  </div>
  <div id="error-message"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const pdfUrl = params.get('pdf');

    if (!pdfUrl) {
      document.getElementById("error-message").textContent = "Error: No se encontr√≥ la direcci√≥n del PDF en la URL. Por favor, agregue ?pdf=URL_DEL_PDF";
    } else {
      let pdfDoc = null, pageNum = 1, scale = 0.95, isHandMode = false, isDragging = false;
      let lastMouseX = 0, lastMouseY = 0, transformX = 0, transformY = 0;
      let isRendering = false;
      let isFirstRender = true; // Variable para controlar la primera carga

      const canvas = document.getElementById("pdf-canvas"), ctx = canvas.getContext("2d");
      const prevButton = document.getElementById("prev-button"), nextButton = document.getElementById("next-button");
      const progressBar = document.getElementById("progress-bar"), timerText = document.getElementById("timer-text");
      const trophyIcon = document.getElementById("trophy-icon"), resetZoomBtn = document.getElementById("reset-zoom-btn");
      const zoomInBtn = document.getElementById("zoom-in-btn"), zoomOutBtn = document.getElementById("zoom-out-btn");
      const handBtn = document.getElementById("hand-btn"), glassOverlay = document.getElementById("glass-overlay");
      let startTime = Date.now();
      
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
        pdfDoc = pdf;
        renderPage(pageNum);
        setInterval(updateTimer, 1000);
      }).catch(error => document.getElementById("error-message").textContent = "Error al cargar el PDF: " + error.message);
      
      async function renderPage(num) {
        isRendering = true;
        try {
          const page = await pdfDoc.getPage(num);
          const viewport = page.getViewport({ scale: scale });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          const renderContext = { canvasContext: ctx, viewport: viewport };
          await page.render(renderContext).promise;

          if (isFirstRender) {
            canvas.style.visibility = 'visible';
            isFirstRender = false;
          }

          canvas.style.transform = `translate(${transformX}px, ${transformY}px)`;
        } catch (error) {
          console.error("Fall√≥ al renderizar la p√°gina:", error);
        } finally {
          glassOverlay.classList.remove("active");
          isRendering = false;
        }
        
        pageNum = num;
        updateButtons();
        updateProgressBar();
      }

      function triggerRender(action) {
        if (isRendering) return;
        glassOverlay.classList.add("active");
        requestAnimationFrame(() => {
          action();
        });
      }

      function zoomIn() { triggerRender(() => { scale = Math.min(scale + 0.2, 3.0); renderPage(pageNum); }); }
      function zoomOut() { triggerRender(() => { scale = Math.max(scale - 0.2, 0.4); renderPage(pageNum); }); }
      function resetZoom() { triggerRender(() => { scale = 0.95; transformX = 0; transformY = 0; renderPage(pageNum); }); }
      
      async function prevPage() {
        if (pageNum <= 1 || isRendering) return;
        glassOverlay.classList.add("active");
        await sleep(500);
        renderPage(pageNum - 1);
      }

      async function nextPage() {
        if (pageNum >= pdfDoc.numPages || isRendering) return;
        glassOverlay.classList.add("active");
        await sleep(500);
        renderPage(pageNum + 1);
      }

      function toggleHand() { isHandMode = !isHandMode; canvas.style.cursor = isHandMode ? 'grab' : 'default'; handBtn.classList.toggle('active', isHandMode); }
      canvas.addEventListener('mousedown', (e) => { if (isHandMode) { isDragging = true; lastMouseX = e.clientX; lastMouseY = e.clientY; canvas.style.cursor = 'grabbing'; } });
      canvas.addEventListener('mousemove', (e) => { if (isDragging) { const dx = e.clientX - lastMouseX, dy = e.clientY - lastMouseY; transformX += dx; transformY += dy; canvas.style.transform = `translate(${transformX}px, ${transformY}px)`; lastMouseX = e.clientX; lastMouseY = e.clientY; } });
      const stopDragging = () => { isDragging = false; if (isHandMode) canvas.style.cursor = 'grab'; };
      canvas.addEventListener('mouseup', stopDragging);
      canvas.addEventListener('mouseleave', stopDragging);
      
      function updateButtons() { if (!pdfDoc) return; prevButton.disabled = (pageNum <= 1); nextButton.disabled = (pageNum >= pdfDoc.numPages); trophyIcon.style.display = (pageNum === pdfDoc.numPages) ? 'flex' : 'none'; }
      function updateProgressBar() { if (!pdfDoc) return; const progress = (pageNum / pdfDoc.numPages) * 100; progressBar.style.width = `${progress}%`; }
      function updateTimer() { const elapsedTime = Math.floor((Date.now() - startTime) / 1000); const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0'); const seconds = String(elapsedTime % 60).padStart(2, '0'); timerText.textContent = `${minutes}:${seconds}`; }
      
      prevButton.addEventListener("click", prevPage);
      nextButton.addEventListener("click", nextPage);
      zoomInBtn.addEventListener("click", zoomIn);
      zoomOutBtn.addEventListener("click", zoomOut);
      handBtn.addEventListener("click", toggleHand);
      resetZoomBtn.addEventListener("click", resetZoom);
    }
  </script>
</body>
</html>